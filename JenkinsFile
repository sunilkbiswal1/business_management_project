pipeline {
    agent any

    environment {
        SONAR_URL = "http://192.168.0.108:9000"
        DOCKER_IMAGE = "spring-boot-app"
        DOCKER_REGISTRY = "sunilkumar45"
        DOCKER_TAG = "${BUILD_NUMBER}"
        REGISTRY_CREDENTIALS = credentials('docker-cred')
        GIT_REPO_NAME = "business_management_project"
        GIT_USER_NAME = "sunilkbiswal1"
    }

    stages {
        stage('Git Checkout') {
            steps {
                echo "========== Cloning Repository ============="
                git branch: 'main',
                  url: 'https://github.com/sunilkbiswal1/business_management_project.git'
            }
        } 

        stage('Verify tools') {
            steps {
                sh '''
                    java --version
                    mvn --version
                    git --version
                    docker --version
                '''
            }
        }

        stage('Maven Build') {
            steps {
                echo '============= Building with Maven ============='
                sh 'mvn clean compile'
            }
        }

        stage('Maven Test') {
            steps {
                echo '================ Unit Testing ================'
                sh 'mvn clean test -DskipTests'
            }
        }

        stage('Maven Package') {
            steps {
                echo '================ Maven Package Building =============='
                sh 'mvn package -DskipTests'
            }
        }

        stage('Static Code Analysis') {
           steps {
              withSonarQubeEnv('sonarqube-server') {
                 withCredentials([string(credentialsId: 'sonrqube', variable: 'SONAR_TOKEN')]) {
                    sh '''
                          mvn clean verify sonar:sonar \
                          -Dsonar.token=$SONAR_TOKEN \
                          -Dsonar.host.url=http://192.168.0.108:9000 \
                          -Dsonar.ws.timeout=120 \
                          -Dsonar.plugins.downloadOnlyRequired=true
                    '''
                    }
                }
            }
        }


        stage('Docker Build') {
            steps {
                script {
                    sh '''
                         docker build -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} .
                         docker tag ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                    '''
                }
            }
        }

        stage('Docker Push') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
                        sh '''
                            docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                            docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                        ''' 
                    }
                }
            }
        }

        stage('Update Deployment File') {
            steps {
                withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                        cd /tmp
                        rm -rf ${GIT_REPO_NAME}

                        echo "clonning repository ............"
                        git clone https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git
                        cd ${GIT_REPO_NAME}

                        echo "Git Configuration.............."
                        git config user.email "biswalpranaati99@gmail.com"
                        git config user.name "sunilkbiswal1"

                        echo "Verify depooyment file exist ............"
                        if [ ! -f Deployment/deployment.yml ]; then
                           echo "Error: deployment.yml not found"
                           exit 1
                        fi

                        echo "Update Deployment File................."
                        sed -i "s/replaceImageTag/${BUILD_NUMBER}/g" Deployment/deployment.yml

                        echo "Add, Commmit & Push..............."
                        git add Deployment/deployment.yml
                        git commit -m "Update Deployment image to version ${BUILD_NUMBER}" || echo "No changes to commit"
                        git push origin main

                        echo "Succesfully pushed chaanged to GitHub"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline executed successfully! üéâ'
        }

        failure {
            echo 'Pipeline failed ‚ùå'
        }
    }
}
